<!DOCTYPE html>

<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>

    <style>

      .state{
        fill: lightgrey;

      }

      .outline{
        fill: none;
        stroke-width: 1px;
        stroke: black;

      }

      .mouseover{
        pointer-events: none;

      }

      svg{
        margin-left: 500px;
        margin-top: 0px;
      }

      h2{
        margin-left: 700px;
        margin-bottom: 0px;
        margin-top: 100px;
      }

      .grat{
        fill: none;
        stroke: grey;
      }


    </style>
    <title> Homework 8 </title>
  </head>
  <body>
    <h1> INFO/CS 3300: Homework 8 </h1>
    <h3> Vishaak Raghupathy </h3>
    <p> I chose the dog breeds dataset because I like dogs and I was curious to see
        what dog breeds were the most popular in the United States. I wanted to see if people from certain states
        or regions(i.e. the Midwest) preferred a certain dog breed over another. I only used
          the top 5 adoptable dog breeds for 2019, which I found out by using a python groupby.count function in Jupyter
          Notebook. I only used the top 5 because it was impractical to display all 190 dog breeds on a small svg.
          I wanted users to see what locations were more likely to adopt a certain breed of dog. In the chart we can
          see that for some breeds like Mixed Breeds, are more common in states like Georgia. I did not add a color legend
          because I felt that most people can decipher that a darker color indicates a higher count and also because it was
          not required. I visualized states using the map, the count using color, and different dog breeds with the mouseover
          legend on the right. I provided a gradicule and mouseover tooltips.
        </p>
    <h2>Adoptable Dog Numbers USA</h2>
    <svg id = "choropleth" width = "900" height = "800"> </svg>
    <script id = "choro">

      const svg = d3.select("#choropleth");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = {top : 20, bottom: 20, left: 20, right: 20};
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                   .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      const requestData = async function(){
        const usa = await d3.json("us-smaller.json");

        const adoptions = await d3.csv("adoptable-dogs.csv");
        const stateIDs = await d3.tsv("us-state-names.tsv");

        var states = topojson.feature(usa, usa.objects.states);
        var statesMesh = topojson.mesh(usa, usa.objects.states);
        var projection = d3.geoAlbersUsa().fitSize([mapWidth - 200, mapHeight - 200], states);
        var path = d3.geoPath().projection(projection);

        var grat = d3.geoGraticule10();
        map.append("path").attr("class","grat").attr("d", path(grat))


        map.append("text").text("Top Breeds:")
           .attr("x", mapWidth - 150)
           .attr("y", 100)
           .style("font-size", "25px")
           .attr("alignment-baseline", "middle")
        map.append("text").text("Mixed Breed")
           .attr("x", mapWidth - 150)
           .attr("class", "Mixed Breed")
           .attr("y", 140)
           .style("font-size", "15px")
           .attr("alignment-baseline", "middle")
           .style("cursor", "pointer")
           .on("mouseover", displayon)
           .on("mouseout", displayoff);
       map.append("text").text("Labrador Retriever")
           .attr("x", mapWidth - 150)
           .attr("class", "Labrador Retriever")
           .attr("y", 170)
           .style("font-size", "15px")
           .attr("alignment-baseline", "middle")
           .style("cursor", "pointer")
           .on("mouseover", displayon)
           .on("mouseout", displayoff);
      map.append("text").text("Pit Bull Terrier")
           .attr("x", mapWidth - 150)
           .attr("class", "Pit Bull Terrier")
           .attr("y", 200)
           .style("font-size", "15px")
           .attr("alignment-baseline", "middle")
           .style("cursor", "pointer")
           .on("mouseover", displayon)
           .on("mouseout", displayoff);
      map.append("text").text("Terrier")
           .attr("x", mapWidth - 150)
           .attr("class", "Terrier")
           .attr("y", 230)
           .style("font-size", "15px")
           .attr("alignment-baseline", "middle")
           .style("cursor", "pointer")
           .on("mouseover", displayon)
           .on("mouseout", displayoff);
      map.append("text").text("Hound")
           .attr("x", mapWidth - 150)
           .attr("class", "Hound")
           .attr("y", 260)
           .style("font-size", "15px")
           .attr("alignment-baseline", "middle")
           .style("cursor", "pointer")
           .on("mouseover", displayon)
           .on("mouseout", displayoff);
      map.append("text").text("Show All")
           .attr("x", mapWidth - 150)
           .attr("class", "found")
           .attr("y", 290)
           .style("font-size", "15px")
           .attr("alignment-baseline", "middle")
           .style("cursor", "pointer")
           .on("mouseover", displayon)
           .on("mouseout", displayoff);
        //.on("click", legend_on);


        map.selectAll("path.state").data(states.features)
           .join("path")
           .attr("class", "state")
           .attr("note", d => d.id)
           .attr("d", path);

        map.append("path").datum(statesMesh)
           .attr("class","outline")
           .attr("d", path);


       let dogCount = {};
       let convertID = {};

      stateIDs.forEach( row => {
        dogCount[row.code] = 0;
        convertID[row.id] = row.code;
      });
      adoptions.forEach( row => {
        dogCount[row.contact_state] += 1;
      });


      const allstates = d3.extent(stateIDs, d => dogCount[d.code]);
      const colorScale = d3.scaleSequential(d3.interpolateYlGn).domain(allstates)
      map.selectAll(".state").style("fill", d => colorScale(dogCount[convertID[d.id]]));




      function displayon(){
        element = d3.select(this);
        element.attr("opacity", 0.7);
        element.attr("text-decoration", "underline");

        stateIDs.forEach(row =>{
          dogCount[row.code] = 0;
        });


        adoptions.forEach( d => {
          if(d.breed_primary === element.attr('class')){
            dogCount[d.contact_state] += 1;
          }

        });


        if(element.attr('class') === "Mixed Breed"){
          const allstates = d3.extent(stateIDs, d => dogCount[d.code]);
          const colorScale = d3.scaleSequential(d3.interpolateRdPu).domain(allstates)
          map.selectAll(".state").style("fill", d => colorScale(dogCount[convertID[d.id]]));


        }
        else if(element.attr('class') === "Labrador Retriever"){
          const allstates = d3.extent(stateIDs, d => dogCount[d.code]);
          const colorScale = d3.scaleSequential(d3.interpolateBuGn).domain(allstates)
          map.selectAll(".state").style("fill", d => colorScale(dogCount[convertID[d.id]]));

        }
        else if(element.attr('class') === "Pit Bull Terrier"){
          const allstates = d3.extent(stateIDs, d => dogCount[d.code]);
          const colorScale = d3.scaleSequential(d3.interpolateYlOrRd).domain(allstates)
          map.selectAll(".state").style("fill", d => colorScale(dogCount[convertID[d.id]]));

        }
        else if(element.attr('class') === "Terrier"){
          const allstates = d3.extent(stateIDs, d => dogCount[d.code]);
          const colorScale = d3.scaleSequential(d3.interpolateGnBu).domain(allstates)
          map.selectAll(".state").style("fill", d => colorScale(dogCount[convertID[d.id]]));

        }
        else if(element.attr('class') === "Hound"){
          const allstates = d3.extent(stateIDs, d => dogCount[d.code]);
          const colorScale = d3.scaleSequential(d3.interpolatePuRd).domain(allstates)
          map.selectAll(".state").style("fill", d => colorScale(dogCount[convertID[d.id]]));

        }
        else{
         stateIDs.forEach( row => {
           dogCount[row.code] = 0;
         });
         adoptions.forEach( row => {
           dogCount[row.contact_state] += 1;
         });

         const allstates = d3.extent(stateIDs, d => dogCount[d.code]);
         const colorScale = d3.scaleSequential(d3.interpolateYlGn).domain(allstates)
         map.selectAll(".state").style("fill", d => colorScale(dogCount[convertID[d.id]]));



        }
      }





      function displayoff(){
        element.attr("opacity", 1);
        element.attr("text-decoration", "");


      }



      let tooltip = map.append("g")
                     .attr("class", "tooltip")
                     .attr("visibility","hidden");
      tooltip.append("rect")
             .attr("fill", "black")
             .attr("opacity", 0.9)
             .attr("x", -60)
             .attr("y", -10)
             .attr("width", 120)
             .attr("height", 40)
      let text1 = tooltip.append("text")
                       .attr("fill", "white")
                       .attr("text-anchor","middle")
                       .attr("alignment-baseline","hanging")
                       .attr("x", 0)
                       .attr("y", 2);
      //let txt2 = tooltip.append("text")
                        //.attr("fill", "white")
                                  //  .attr("text-anchor","middle")
                                  //  .attr("alignment-baseline","hanging")
                                  //  .attr("x", 0)
                                  //  .attr("y", 22);
      let out =  map.append("path")
                       .attr("class","mouseover outline")
                       .attr("d", "");

      d3.selectAll(".state").on("mouseenter", enter);
      d3.selectAll(".state").on("mouseout",  leave);

      function enter(){
        tooltip.style("visibility","visible")

        let state = d3.select(this);
        let stateID = state.datum().id;

        var show = topojson.mesh(usa, usa.objects.states, function(a, b) { return a.id === stateIDs || b.id === stateIDs; });
        out.datum(show).attr("d", path)
        text1.text(convertID[stateID] + ": " + dogCount[convertID[stateID]]);
        let centroid = path.centroid( state.datum() );  // Get the pixel "center" of the state
        let bounds = path.bounds( state.datum() );
        let xp = (bounds[0][0]+bounds[1][0])/2.0;
        let yp = bounds[1][1];
        tooltip.attr("transform",`translate(${xp},${yp})`);




      }

      function leave(){
        tooltip.style("visibility","hidden");
        let state = d3.select(this);
        out.attr("d", "");

      }







      }

      requestData();

    </script>
  </body>
</html>
